# Dyad æµ‹è¯•æ¶æ„è¯¦è§£ / Dyad Testing Architecture Deep Dive

é€šè¿‡æµ‹è¯•æ¥ç†è§£é¡¹ç›®æ˜¯ä¸€ä¸ªç»ä½³çš„æ–¹æ³•ï¼Dyad çš„æµ‹è¯•æ¶æ„éå¸¸å®Œå–„ï¼Œæ¶µç›–äº†å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•ã€‚è®©æˆ‘ä»¬ä»æµ‹è¯•çš„è§’åº¦æ¥é€æ­¥ç†è§£è¿™ä¸ªé¡¹ç›®ã€‚

Understanding a project through its tests is an excellent approach! Dyad has a comprehensive testing architecture covering unit tests, integration tests, and end-to-end tests. Let's understand this project step by step from a testing perspective.

## ğŸ§ª æµ‹è¯•æ¡†æ¶æ¦‚è§ˆ / Testing Framework Overview

### æµ‹è¯•æŠ€æœ¯æ ˆ / Testing Technology Stack
- **å•å…ƒæµ‹è¯• / Unit Tests**: Vitest + Happy DOM
- **ç«¯åˆ°ç«¯æµ‹è¯• / End-to-End Tests**: Playwright + Electron
- **æµ‹è¯•ç¯å¢ƒ / Testing Environment**: æ¨¡æ‹Ÿ LLM æœåŠ¡å™¨ + çœŸå® Electron åº”ç”¨ / Mock LLM Server + Real Electron App

### æµ‹è¯•é…ç½®
```typescript
// vitest.config.ts - å•å…ƒæµ‹è¯•é…ç½®
{
  environment: "happy-dom",  // æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒ
  include: ["src/**/*.{test,spec}.{ts,tsx}"],
  globals: true,  // å…¨å±€æµ‹è¯•å‡½æ•°
}

// playwright.config.ts - E2E æµ‹è¯•é…ç½®
{
  testDir: "./e2e-tests",
  workers: 1,  // å•çº¿ç¨‹è¿è¡Œé¿å…å†²çª
  webServer: "fake-llm-server",  // æ¨¡æ‹Ÿ AI æœåŠ¡
}
```

## ğŸ” ä»æµ‹è¯•ç†è§£é¡¹ç›®æ ¸å¿ƒåŠŸèƒ½ / Understanding Core Features Through Tests

### 1. æ ¸å¿ƒæ¶æ„ - IPC é€šä¿¡æµ‹è¯• / Core Architecture - IPC Communication Tests

**æµ‹è¯•æ–‡ä»¶**: `src/__tests__/chat_stream_handlers.test.ts`

è¿™ä¸ªæµ‹è¯•æ­ç¤ºäº† Dyad çš„æ ¸å¿ƒæ¶æ„ï¼š

#### AI å“åº”å¤„ç†ç³»ç»Ÿ
```typescript
// Dyad ä½¿ç”¨ç‰¹æ®Šçš„ XML æ ‡ç­¾æ¥å¤„ç† AI å“åº”
describe("getDyadWriteTags", () => {
  it("should return a dyad-write tag", () => {
    const result = getDyadWriteTags(`
      <dyad-write path="src/components/TodoItem.tsx" description="Creating a component">
        import React from "react";
        console.log("TodoItem");
      </dyad-write>
    `);
    // è§£æå‡ºæ–‡ä»¶è·¯å¾„ã€æè¿°å’Œå†…å®¹
  });
});
```

**å…³é”®å‘ç°**:
- Dyad é€šè¿‡ `<dyad-write>`, `<dyad-rename>`, `<dyad-delete>` æ ‡ç­¾å¤„ç† AI ç”Ÿæˆçš„ä»£ç 
- æ”¯æŒæ–‡ä»¶åˆ›å»ºã€é‡å‘½åã€åˆ é™¤ç­‰æ“ä½œ
- è‡ªåŠ¨è¿›è¡Œ Git ç‰ˆæœ¬æ§åˆ¶

#### æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
```typescript
describe("processFullResponse", () => {
  it("should process dyad-write tags and create files", async () => {
    const response = `<dyad-write path="src/file1.js">console.log('Hello');</dyad-write>`;
    
    // éªŒè¯æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
    expect(fs.mkdirSync).toHaveBeenCalledWith("/path/to/app/src", { recursive: true });
    expect(fs.writeFileSync).toHaveBeenCalledWith("/path/to/app/src/file1.js", "console.log('Hello');");
    expect(gitAdd).toHaveBeenCalled();
    expect(gitCommit).toHaveBeenCalled();
  });
});
```

### 2. åº”ç”¨æåŠç³»ç»Ÿæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `src/__tests__/mention_apps.test.ts`

æ­ç¤ºäº† Dyad çš„å¤šåº”ç”¨ç®¡ç†åŠŸèƒ½ï¼š

```typescript
describe("parseAppMentions", () => {
  it("should parse basic app mentions", () => {
    const prompt = "Can you help me with @app:MyApp and @app:AnotherApp?";
    const result = parseAppMentions(prompt);
    expect(result).toEqual(["MyApp", "AnotherApp"]);
  });
});
```

**å…³é”®å‘ç°**:
- æ”¯æŒ `@app:AppName` è¯­æ³•æ¥å¼•ç”¨ä¸åŒçš„åº”ç”¨
- å¯ä»¥åœ¨ä¸€ä¸ªå¯¹è¯ä¸­ç®¡ç†å¤šä¸ªåº”ç”¨é¡¹ç›®
- æ”¯æŒåº”ç”¨é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢

### 3. è·¯å¾„å®‰å…¨æµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `src/__tests__/path_utils.test.ts`

å±•ç¤ºäº†å®‰å…¨çš„æ–‡ä»¶è·¯å¾„å¤„ç†ï¼š

```typescript
describe("safeJoin", () => {
  it("should throw on directory traversal", () => {
    expect(() => safeJoin("/base", "../outside.txt"))
      .toThrow(/would escape the base directory/);
  });
});
```

**å…³é”®å‘ç°**:
- ä¸¥æ ¼çš„è·¯å¾„éªŒè¯ï¼Œé˜²æ­¢ç›®å½•éå†æ”»å‡»
- æ”¯æŒè·¨å¹³å°è·¯å¾„å¤„ç†ï¼ˆWindows/Unixï¼‰
- ç¡®ä¿æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½åœ¨åº”ç”¨ç›®å½•å†…

## ğŸ­ ç«¯åˆ°ç«¯æµ‹è¯• - å®Œæ•´ç”¨æˆ·æµç¨‹

### æµ‹è¯•è¦†ç›–çš„ä¸»è¦åŠŸèƒ½

ä» `e2e-tests/` ç›®å½•å¯ä»¥çœ‹å‡º Dyad çš„å®Œæ•´åŠŸèƒ½é›†ï¼š

#### 1. æ ¸å¿ƒèŠå¤©åŠŸèƒ½
- **`chat_mode.spec.ts`** - èŠå¤©æ¨¡å¼åˆ‡æ¢ï¼ˆæ„å»ºæ¨¡å¼ vs è¯¢é—®æ¨¡å¼ï¼‰
- **`chat_input.spec.ts`** - èŠå¤©è¾“å…¥å¤„ç†
- **`new_chat.spec.ts`** - æ–°å»ºèŠå¤©ä¼šè¯

#### 2. AI æä¾›å•†é›†æˆ
- **`azure_send_message.spec.ts`** - Azure OpenAI é›†æˆ
- **`ollama.spec.ts`** - æœ¬åœ° Ollama æ¨¡å‹
- **`lm_studio.spec.ts`** - LM Studio é›†æˆ
- **`engine.spec.ts`** - è‡ªå®šä¹‰ AI å¼•æ“

#### 3. ä»£ç ç¼–è¾‘åŠŸèƒ½
- **`edit_code.spec.ts`** - ä»£ç ç¼–è¾‘å™¨
- **`dyad_tags_parsing.spec.ts`** - AI æ ‡ç­¾è§£æ
- **`turbo_edits_v2.spec.ts`** - å¿«é€Ÿç¼–è¾‘åŠŸèƒ½
- **`visual_editing.spec.ts`** - å¯è§†åŒ–ç¼–è¾‘

#### 4. é¡¹ç›®ç®¡ç†
- **`import.spec.ts`** - é¡¹ç›®å¯¼å…¥
- **`copy_app.spec.ts`** - åº”ç”¨å¤åˆ¶
- **`delete_app.spec.ts`** - åº”ç”¨åˆ é™¤
- **`switch_apps.spec.ts`** - åº”ç”¨åˆ‡æ¢

#### 5. ç‰ˆæœ¬æ§åˆ¶é›†æˆ
- **`github.spec.ts`** - GitHub é›†æˆ
- **`github-import.spec.ts`** - ä» GitHub å¯¼å…¥
- **`version_integrity.spec.ts`** - ç‰ˆæœ¬å®Œæ•´æ€§

#### 6. æ•°æ®åº“é›†æˆ
- **`supabase_*.spec.ts`** - Supabase æ•°æ®åº“é›†æˆ
- **`supabase_migrations.spec.ts`** - æ•°æ®åº“è¿ç§»

#### 7. é«˜çº§åŠŸèƒ½
- **`mcp.spec.ts`** - Model Context Protocol æ”¯æŒ
- **`security_review.spec.ts`** - å®‰å…¨å®¡æŸ¥
- **`context_manage.spec.ts`** - ä¸Šä¸‹æ–‡ç®¡ç†
- **`smart_context_*.spec.ts`** - æ™ºèƒ½ä¸Šä¸‹æ–‡

### å…¸å‹çš„ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹

```typescript
test("chat mode selector - default build mode", async ({ po }) => {
  await po.setUp({ autoApprove: true });     // è®¾ç½®æµ‹è¯•ç¯å¢ƒ
  await po.importApp("minimal");             // å¯¼å…¥æœ€å°åº”ç”¨
  await po.sendPrompt("[dump] hi");          // å‘é€æç¤º
  await po.waitForChatCompletion();         // ç­‰å¾… AI å“åº”
  await po.snapshotMessages();              // éªŒè¯ç»“æœ
});
```

## ğŸ—ï¸ ä»æµ‹è¯•ç†è§£é¡¹ç›®æ¶æ„

### 1. åˆ†å±‚æ¶æ„

é€šè¿‡æµ‹è¯•å¯ä»¥çœ‹å‡º Dyad çš„åˆ†å±‚æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React UI      â”‚ â† ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   IPC Client    â”‚ â† å•å…ƒæµ‹è¯• mock
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   IPC Handlers  â”‚ â† é‡ç‚¹æµ‹è¯•åŒºåŸŸ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   File System   â”‚ â† è·¯å¾„å®‰å…¨æµ‹è¯•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Git/Database  â”‚ â† é›†æˆæµ‹è¯•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒæ•°æ®æµ

æµ‹è¯•æ­ç¤ºäº†æ•°æ®æµå‘ï¼š

```
ç”¨æˆ·è¾“å…¥ â†’ IPC Client â†’ IPC Handler â†’ AI æœåŠ¡ â†’ å“åº”è§£æ â†’ æ–‡ä»¶æ“ä½œ â†’ Git æäº¤
```

### 3. å®‰å…¨è¾¹ç•Œ

æµ‹è¯•å¼ºè°ƒäº†å®‰å…¨è€ƒè™‘ï¼š
- è·¯å¾„éå†é˜²æŠ¤
- IPC è¾¹ç•ŒéªŒè¯
- æ–‡ä»¶æ“ä½œæƒé™æ§åˆ¶

## ğŸš€ é€šè¿‡æµ‹è¯•å­¦ä¹ é¡¹ç›®çš„å»ºè®®

### 1. ä»ç®€å•æµ‹è¯•å¼€å§‹
```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•äº†è§£åŸºæœ¬åŠŸèƒ½
npm test src/__tests__/mention_apps.test.ts
```

### 2. æŸ¥çœ‹æµ‹è¯•å¿«ç…§
```bash
# æŸ¥çœ‹ç«¯åˆ°ç«¯æµ‹è¯•çš„é¢„æœŸè¾“å‡º
cat e2e-tests/snapshots/main.spec.ts_simple-message-to-custom-test-model-1.aria.yml
```

### 3. è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
```bash
# è§‚å¯Ÿå®Œæ•´çš„ç”¨æˆ·æµç¨‹
npm run e2e -- --headed  # å¯è§†åŒ–è¿è¡Œ
```

### 4. ç†è§£æµ‹è¯•è¾…åŠ©å·¥å…·
- **`test_helper.ts`** - æä¾›é¡µé¢å¯¹è±¡æ¨¡å¼
- **`fake-llm-server`** - æ¨¡æ‹Ÿ AI æœåŠ¡å“åº”
- **å¿«ç…§æµ‹è¯•** - éªŒè¯ UI çŠ¶æ€å’Œæ•°æ®è¾“å‡º

## ğŸ“š æµ‹è¯•é©±åŠ¨çš„å­¦ä¹ è·¯å¾„

### ç¬¬ä¸€é˜¶æ®µï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µ
1. é˜…è¯» `mention_apps.test.ts` - äº†è§£åº”ç”¨æåŠç³»ç»Ÿ
2. é˜…è¯» `path_utils.test.ts` - ç†è§£å®‰å…¨æ–‡ä»¶å¤„ç†
3. é˜…è¯» `chat_stream_handlers.test.ts` - æŒæ¡ AI å“åº”å¤„ç†

### ç¬¬äºŒé˜¶æ®µï¼šç†è§£ç”¨æˆ·æµç¨‹
1. è¿è¡Œ `main.spec.ts` - åŸºæœ¬èŠå¤©åŠŸèƒ½
2. è¿è¡Œ `chat_mode.spec.ts` - æ¨¡å¼åˆ‡æ¢
3. è¿è¡Œ `import.spec.ts` - é¡¹ç›®å¯¼å…¥æµç¨‹

### ç¬¬ä¸‰é˜¶æ®µï¼šç†è§£é«˜çº§åŠŸèƒ½ï½
1. ç ”ç©¶ `mcp.spec.ts` - æ‰©å±•åè®®æ”¯æŒ
2. ç ”ç©¶ `github.spec.ts` - ç‰ˆæœ¬æ§åˆ¶é›†æˆ
3. ç ”ç©¶ `supabase_*.spec.ts` - æ•°æ®åº“é›†æˆ

### ç¬¬å››é˜¶æ®µï¼šç†è§£æ¶æ„è®¾è®¡
1. åˆ†ææµ‹è¯•çš„ mock ç­–ç•¥
2. ç†è§£ IPC é€šä¿¡æ¨¡å¼
3. æŒæ¡å®‰å…¨å’Œé”™è¯¯å¤„ç†

é€šè¿‡è¿™ç§æµ‹è¯•é©±åŠ¨çš„å­¦ä¹ æ–¹å¼ï¼Œä½ å¯ä»¥ï¼š
- **å¿«é€Ÿç†è§£åŠŸèƒ½** - æµ‹è¯•ç”¨ä¾‹å°±æ˜¯åŠŸèƒ½è§„æ ¼
- **æŒæ¡æ•°æ®æµ** - æµ‹è¯•å±•ç¤ºäº†æ•°æ®å¦‚ä½•æµè½¬
- **ç†è§£è¾¹ç•Œæ¡ä»¶** - æµ‹è¯•è¦†ç›–äº†å„ç§å¼‚å¸¸æƒ…å†µ
- **å­¦ä¹ æœ€ä½³å®è·µ** - æµ‹è¯•ä½“ç°äº†ä»£ç è´¨é‡æ ‡å‡†

æµ‹è¯•ä¸ä»…æ˜¯è´¨é‡ä¿è¯å·¥å…·ï¼Œæ›´æ˜¯ç†è§£å¤æ‚é¡¹ç›®çš„æœ€ä½³å…¥å£ï¼